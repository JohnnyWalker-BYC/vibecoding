<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>íšŒì› ê´€ë¦¬ - Korean Pets Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KRF069BCHX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KRF069BCHX');
    </script>
</head>
<body>
    <!-- í—¤ë” ë¡œë“œ -->
    <div id="header-placeholder"></div>

    <div class="admin-container">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>ğŸ› ï¸ ê´€ë¦¬ì</h2>
                <div class="admin-info" id="admin-info">
                    <div class="loading">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" onclick="showSection('dashboard')">
                    <span class="icon">ğŸ“Š</span>
                    <span class="label">ëŒ€ì‹œë³´ë“œ</span>
                </a>
                <a href="#users" class="nav-item" onclick="showSection('users')">
                    <span class="icon">ğŸ‘¥</span>
                    <span class="label">íšŒì› ê´€ë¦¬</span>
                </a>
                <a href="#newsletter" class="nav-item" onclick="showSection('newsletter')">
                    <span class="icon">ğŸ“§</span>
                    <span class="label">ë‰´ìŠ¤ë ˆí„° êµ¬ë…ì</span>
                </a>
                <a href="#activity" class="nav-item" onclick="showSection('activity')">
                    <span class="icon">ğŸ“</span>
                    <span class="label">í™œë™ ë¡œê·¸</span>
                </a>
                <a href="#settings" class="nav-item" onclick="showSection('settings')">
                    <span class="icon">âš™ï¸</span>
                    <span class="label">ì„¤ì •</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button onclick="handleLogout()" class="btn-logout">
                    ğŸšª ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="admin-main">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <section id="dashboard-section" class="admin-section active">
                <div class="section-header">
                    <h1>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
                    <button onclick="refreshDashboard()" class="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-users">-</div>
                            <div class="stat-label">ì „ì²´ íšŒì›</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-content">
                            <div class="stat-value" id="active-users">-</div>
                            <div class="stat-label">í™œì„± íšŒì›</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ†•</div>
                        <div class="stat-content">
                            <div class="stat-value" id="new-users-week">-</div>
                            <div class="stat-label">ì´ë²ˆ ì£¼ ì‹ ê·œ</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“§</div>
                        <div class="stat-content">
                            <div class="stat-value" id="newsletter-count">-</div>
                            <div class="stat-label">ë‰´ìŠ¤ë ˆí„° êµ¬ë…ì</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>ğŸ“ˆ ìµœê·¼ ê°€ì… ì¶”ì´</h3>
                        <div id="recent-signups" class="chart-placeholder">
                            ë°ì´í„° ë¡œë”© ì¤‘...
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3>ğŸ”¥ ìµœê·¼ í™œë™</h3>
                        <div id="recent-activity-dashboard">
                            <div class="loading">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- íšŒì› ê´€ë¦¬ -->
            <section id="users-section" class="admin-section">
                <div class="section-header">
                    <h1>ğŸ‘¥ íšŒì› ê´€ë¦¬</h1>
                    <div class="header-actions">
                        <input type="text" id="user-search" placeholder="ì´ë©”ì¼, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." class="search-input">
                        <button onclick="searchUsers()" class="btn-primary">ğŸ” ê²€ìƒ‰</button>
                        <button onclick="loadUsers()" class="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì´ë¦„</th>
                                <th>ê°€ì…ì¼</th>
                                <th>ìµœê·¼ ë¡œê·¸ì¸</th>
                                <th>ìƒíƒœ</th>
                                <th>ê´€ë¦¬ì</th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="8" class="loading-cell">
                                    <div class="loading">íšŒì› ëª©ë¡ ë¡œë”© ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="users-pagination">
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </section>

            <!-- ë‰´ìŠ¤ë ˆí„° êµ¬ë…ì -->
            <section id="newsletter-section" class="admin-section">
                <div class="section-header">
                    <h1>ğŸ“§ ë‰´ìŠ¤ë ˆí„° êµ¬ë…ì</h1>
                    <div class="header-actions">
                        <button onclick="exportNewsletterCSV()" class="btn-secondary">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
                        <button onclick="loadNewsletterSubscribers()" class="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="newsletter-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì´ë©”ì¼</th>
                                <th>íšŒì› ì—°ê²°</th>
                                <th>êµ¬ë…ì¼</th>
                                <th>ìƒíƒœ</th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="newsletter-tbody">
                            <tr>
                                <td colspan="6" class="loading-cell">
                                    <div class="loading">êµ¬ë…ì ëª©ë¡ ë¡œë”© ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- í™œë™ ë¡œê·¸ -->
            <section id="activity-section" class="admin-section">
                <div class="section-header">
                    <h1>ğŸ“ í™œë™ ë¡œê·¸</h1>
                    <div class="header-actions">
                        <select id="activity-filter" onchange="filterActivityLogs()" class="filter-select">
                            <option value="all">ì „ì²´</option>
                            <option value="login">ë¡œê·¸ì¸</option>
                            <option value="logout">ë¡œê·¸ì•„ì›ƒ</option>
                            <option value="signup">íšŒì›ê°€ì…</option>
                            <option value="profile_update">í”„ë¡œí•„ ìˆ˜ì •</option>
                            <option value="password_change">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</option>
                        </select>
                        <button onclick="loadActivityLogs()" class="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="activity-table">
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ì‚¬ìš©ì</th>
                                <th>í™œë™ ìœ í˜•</th>
                                <th>ì„¤ëª…</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="activity-tbody">
                            <tr>
                                <td colspan="5" class="loading-cell">
                                    <div class="loading">í™œë™ ë¡œê·¸ ë¡œë”© ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ì„¤ì • -->
            <section id="settings-section" class="admin-section">
                <div class="section-header">
                    <h1>âš™ï¸ ì„¤ì •</h1>
                </div>

                <div class="settings-container">
                    <div class="settings-card">
                        <h3>ğŸ”‘ ê´€ë¦¬ì ì •ë³´</h3>
                        <div id="admin-profile-info">
                            <div class="loading">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ</h3>
                        <div id="database-status">
                            <button onclick="checkDatabaseStatus()" class="btn-primary">
                                ìƒíƒœ í™•ì¸
                            </button>
                            <div id="db-status-result" class="status-result"></div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>ğŸ“Š Supabase ì—°ê²°</h3>
                        <div class="connection-info">
                            <p><strong>í”„ë¡œì íŠ¸ URL:</strong></p>
                            <code>https://fgdgsbmvxiqabedctxbw.supabase.co</code>
                            <br><br>
                            <button onclick="testConnection()" class="btn-secondary">
                                ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                            <div id="connection-test-result" class="status-result"></div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>ğŸ› ï¸ ìœ ì§€ë³´ìˆ˜</h3>
                        <div class="maintenance-actions">
                            <button onclick="cleanupOldLogs()" class="btn-secondary">
                                ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (30ì¼ ì´ìƒ)
                            </button>
                            <button onclick="exportAllData()" class="btn-secondary">
                                ì „ì²´ ë°ì´í„° ë°±ì—…
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- í‘¸í„° ë¡œë“œ -->
    <div id="footer-placeholder"></div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    <script>
        // ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™”
        let currentUser = null;
        let allUsers = [];
        let allNewsletterSubscribers = [];
        let allActivityLogs = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('DOMContentLoaded', async () => {
            // í—¤ë”/í‘¸í„° ë¡œë“œ
            await loadHeaderFooter();
            
            // Supabase ì´ˆê¸°í™” ëŒ€ê¸°
            if (typeof initSupabase === 'function') {
                initSupabase();
            }
            
            // ì¸ì¦ í™•ì¸
            await checkAdminAuth();
            
            // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            await loadDashboard();
        });

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        async function checkAdminAuth() {
            try {
                if (!window.supabase) {
                    throw new Error('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/index.html';
                    return;
                }

                currentUser = session.user;

                // í”„ë¡œí•„ í™•ì¸
                const { data: profile, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error || !profile) {
                    alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                if (!profile.is_admin) {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/index.html';
                    return;
                }

                // ê´€ë¦¬ì ì •ë³´ í‘œì‹œ
                document.getElementById('admin-info').innerHTML = `
                    <div class="admin-badge">ğŸ‘‘ ê´€ë¦¬ì</div>
                    <div class="admin-email">${currentUser.email}</div>
                `;

            } catch (error) {
                console.error('ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
                alert('ì¸ì¦ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì„¹ì…˜ ì „í™˜
        function showSection(sectionName) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });

            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // ì„ íƒí•œ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // ì„ íƒí•œ ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© í™œì„±í™”
            event.currentTarget.classList.add('active');

            // ì„¹ì…˜ë³„ ë°ì´í„° ë¡œë“œ
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'newsletter':
                    loadNewsletterSubscribers();
                    break;
                case 'activity':
                    loadActivityLogs();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                // í†µê³„ ë¡œë“œ
                const { data: stats, error: statsError } = await supabase
                    .from('user_statistics')
                    .select('*')
                    .single();

                if (!statsError && stats) {
                    document.getElementById('total-users').textContent = stats.total_users || 0;
                    document.getElementById('active-users').textContent = stats.active_users || 0;
                    document.getElementById('new-users-week').textContent = stats.new_users_this_week || 0;
                }

                // ë‰´ìŠ¤ë ˆí„° êµ¬ë…ì ìˆ˜
                const { count: newsletterCount } = await supabase
                    .from('newsletter_subscribers')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('newsletter-count').textContent = newsletterCount || 0;

                // ìµœê·¼ í™œë™
                await loadRecentActivity();

                // ìµœê·¼ ê°€ì…ì
                await loadRecentSignups();

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìµœê·¼ í™œë™ ë¡œë“œ
        async function loadRecentActivity() {
            try {
                const { data: activities, error } = await supabase
                    .from('recent_user_activity')
                    .select('*')
                    .limit(10);

                if (error) throw error;

                const container = document.getElementById('recent-activity-dashboard');
                if (!activities || activities.length === 0) {
                    container.innerHTML = '<p class="no-data">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                container.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <span class="activity-time">${formatDate(activity.created_at)}</span>
                        <span class="activity-user">${activity.email || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                        <span class="activity-type">${getActivityTypeLabel(activity.activity_type)}</span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('ìµœê·¼ í™œë™ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('recent-activity-dashboard').innerHTML = 
                    '<p class="error">í™œë™ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ìµœê·¼ ê°€ì…ì ë¡œë“œ
        async function loadRecentSignups() {
            try {
                const { data: users, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(7);

                if (error) throw error;

                const container = document.getElementById('recent-signups');
                if (!users || users.length === 0) {
                    container.innerHTML = '<p class="no-data">ìµœê·¼ ê°€ì…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // ê°„ë‹¨í•œ ì°¨íŠ¸ í˜•íƒœë¡œ í‘œì‹œ
                container.innerHTML = users.map(user => `
                    <div class="signup-item">
                        <span class="signup-date">${formatDate(user.created_at)}</span>
                        <span class="signup-email">${user.email}</span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('ìµœê·¼ ê°€ì…ì ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íšŒì› ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading-cell"><div class="loading">ë¡œë”© ì¤‘...</div></td></tr>';

                const { data: users, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allUsers = users || [];

                if (allUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="no-data-cell">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = allUsers.map(user => `
                    <tr>
                        <td><code>${user.id.substring(0, 8)}...</code></td>
                        <td>${user.email}</td>
                        <td>${user.full_name || user.username || '-'}</td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>${user.last_login_at ? formatDate(user.last_login_at) : '-'}</td>
                        <td>
                            <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                                ${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${user.is_admin ? 'badge-primary' : 'badge-secondary'}">
                                ${user.is_admin ? 'âœ“' : 'âœ—'}
                            </span>
                        </td>
                        <td>
                            <button onclick="viewUser('${user.id}')" class="btn-sm btn-info">ğŸ‘ï¸</button>
                            <button onclick="editUser('${user.id}')" class="btn-sm btn-warning">âœï¸</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('íšŒì› ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('users-tbody').innerHTML = 
                    `<tr><td colspan="8" class="error-cell">ì˜¤ë¥˜: ${error.message}</td></tr>`;
            }
        }

        // ë‰´ìŠ¤ë ˆí„° êµ¬ë…ì ë¡œë“œ
        async function loadNewsletterSubscribers() {
            try {
                const tbody = document.getElementById('newsletter-tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading-cell"><div class="loading">ë¡œë”© ì¤‘...</div></td></tr>';

                const { data: subscribers, error } = await supabase
                    .from('newsletter_subscribers')
                    .select('*')
                    .order('subscribed_at', { ascending: false });

                if (error) throw error;

                allNewsletterSubscribers = subscribers || [];

                if (allNewsletterSubscribers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data-cell">êµ¬ë…ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = allNewsletterSubscribers.map(sub => `
                    <tr>
                        <td><code>${sub.id.substring(0, 8)}...</code></td>
                        <td>${sub.email}</td>
                        <td>${sub.user_id ? 'âœ“ ì—°ê²°ë¨' : 'âœ— ë¹„íšŒì›'}</td>
                        <td>${formatDate(sub.subscribed_at)}</td>
                        <td>
                            <span class="badge ${sub.is_active ? 'badge-success' : 'badge-danger'}">
                                ${sub.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                            </span>
                        </td>
                        <td>
                            <button onclick="unsubscribe('${sub.id}')" class="btn-sm btn-danger">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('êµ¬ë…ì ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('newsletter-tbody').innerHTML = 
                    `<tr><td colspan="6" class="error-cell">ì˜¤ë¥˜: ${error.message}</td></tr>`;
            }
        }

        // í™œë™ ë¡œê·¸ ë¡œë“œ
        async function loadActivityLogs() {
            try {
                const tbody = document.getElementById('activity-tbody');
                tbody.innerHTML = '<tr><td colspan="5" class="loading-cell"><div class="loading">ë¡œë”© ì¤‘...</div></td></tr>';

                const { data: logs, error } = await supabase
                    .from('recent_user_activity')
                    .select('*')
                    .limit(100);

                if (error) throw error;

                allActivityLogs = logs || [];

                if (allActivityLogs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data-cell">í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                displayActivityLogs(allActivityLogs);

            } catch (error) {
                console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('activity-tbody').innerHTML = 
                    `<tr><td colspan="5" class="error-cell">ì˜¤ë¥˜: ${error.message}</td></tr>`;
            }
        }

        // í™œë™ ë¡œê·¸ í‘œì‹œ
        function displayActivityLogs(logs) {
            const tbody = document.getElementById('activity-tbody');
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${formatDateTime(log.created_at)}</td>
                    <td>${log.email || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td>
                        <span class="badge badge-info">
                            ${getActivityTypeLabel(log.activity_type)}
                        </span>
                    </td>
                    <td>${log.activity_description || '-'}</td>
                    <td><code>${'IP ì •ë³´ ì—†ìŒ'}</code></td>
                </tr>
            `).join('');
        }

        // í™œë™ íƒ€ì… ë ˆì´ë¸”
        function getActivityTypeLabel(type) {
            const labels = {
                'login': 'ğŸ”‘ ë¡œê·¸ì¸',
                'logout': 'ğŸšª ë¡œê·¸ì•„ì›ƒ',
                'signup': 'âœ¨ íšŒì›ê°€ì…',
                'profile_update': 'âœï¸ í”„ë¡œí•„ ìˆ˜ì •',
                'password_change': 'ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½',
                'newsletter_subscribe': 'ğŸ“§ ë‰´ìŠ¤ë ˆí„° êµ¬ë…'
            };
            return labels[type] || type;
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR');
        }

        // ì„¤ì • ë¡œë“œ
        async function loadSettings() {
            try {
                const container = document.getElementById('admin-profile-info');
                
                if (currentUser) {
                    const { data: profile } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();

                    container.innerHTML = `
                        <div class="profile-info">
                            <p><strong>ì´ë©”ì¼:</strong> ${currentUser.email}</p>
                            <p><strong>ê°€ì…ì¼:</strong> ${formatDate(profile.created_at)}</p>
                            <p><strong>ë¡œê·¸ì¸ íšŸìˆ˜:</strong> ${profile.login_count || 0}íšŒ</p>
                            <p><strong>ê´€ë¦¬ì ê¶Œí•œ:</strong> ${profile.is_admin ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
        async function checkDatabaseStatus() {
            const resultDiv = document.getElementById('db-status-result');
            resultDiv.innerHTML = '<div class="loading">í™•ì¸ ì¤‘...</div>';

            try {
                const tables = ['user_profiles', 'user_activity_logs', 'user_sessions', 'newsletter_subscribers'];
                const results = [];

                for (const table of tables) {
                    const { count, error } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });

                    results.push({
                        table: table,
                        exists: !error,
                        count: count || 0,
                        error: error ? error.message : null
                    });
                }

                resultDiv.innerHTML = `
                    <div class="status-list">
                        ${results.map(r => `
                            <div class="status-item ${r.exists ? 'success' : 'error'}">
                                <strong>${r.table}</strong>: 
                                ${r.exists ? `âœ… ì •ìƒ (${r.count}ê°œ ë ˆì½”ë“œ)` : `âŒ ì˜¤ë¥˜ - ${r.error}`}
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            const resultDiv = document.getElementById('connection-test-result');
            resultDiv.innerHTML = '<div class="loading">í…ŒìŠ¤íŠ¸ ì¤‘...</div>';

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('count', { count: 'exact', head: true });

                if (error) throw error;

                resultDiv.innerHTML = '<div class="success">âœ… ì—°ê²° ì„±ê³µ!</div>';

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        function exportNewsletterCSV() {
            if (allNewsletterSubscribers.length === 0) {
                alert('êµ¬ë…ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const csv = [
                ['ID', 'ì´ë©”ì¼', 'êµ¬ë…ì¼', 'ìƒíƒœ'].join(','),
                ...allNewsletterSubscribers.map(sub => [
                    sub.id,
                    sub.email,
                    formatDate(sub.subscribed_at),
                    sub.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `newsletter_subscribers_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ê²€ìƒ‰
        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            if (!searchTerm) {
                displayUsers(allUsers);
                return;
            }

            const filtered = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
                (user.username && user.username.toLowerCase().includes(searchTerm))
            );

            displayUsers(filtered);
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-tbody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data-cell">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><code>${user.id.substring(0, 8)}...</code></td>
                    <td>${user.email}</td>
                    <td>${user.full_name || user.username || '-'}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${user.last_login_at ? formatDate(user.last_login_at) : '-'}</td>
                    <td>
                        <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                            ${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${user.is_admin ? 'badge-primary' : 'badge-secondary'}">
                            ${user.is_admin ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td>
                        <button onclick="viewUser('${user.id}')" class="btn-sm btn-info">ğŸ‘ï¸</button>
                        <button onclick="editUser('${user.id}')" class="btn-sm btn-warning">âœï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        // ì‚¬ìš©ì ìƒì„¸ë³´ê¸°
        function viewUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            alert(`íšŒì› ì •ë³´\n\nì´ë©”ì¼: ${user.email}\nì´ë¦„: ${user.full_name || '-'}\nê°€ì…ì¼: ${formatDate(user.created_at)}\nìƒíƒœ: ${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}`);
        }

        // ì‚¬ìš©ì ìˆ˜ì •
        function editUser(userId) {
            alert('ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.');
        }

        // êµ¬ë… ì·¨ì†Œ
        async function unsubscribe(subscriberId) {
            if (!confirm('ì •ë§ êµ¬ë…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabase
                    .from('newsletter_subscribers')
                    .delete()
                    .eq('id', subscriberId);

                if (error) throw error;

                alert('êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadNewsletterSubscribers();

            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }

        // í™œë™ í•„í„°ë§
        function filterActivityLogs() {
            const filter = document.getElementById('activity-filter').value;
            
            if (filter === 'all') {
                displayActivityLogs(allActivityLogs);
                return;
            }

            const filtered = allActivityLogs.filter(log => log.activity_type === filter);
            displayActivityLogs(filtered);
        }

        // ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ë“¤
        function refreshDashboard() {
            loadDashboard();
        }

        // í—¤ë”/í‘¸í„° ë¡œë“œ
        async function loadHeaderFooter() {
            try {
                const headerResponse = await fetch('_header.html');
                const headerHTML = await headerResponse.text();
                document.getElementById('header-placeholder').innerHTML = headerHTML;

                const footerResponse = await fetch('_footer.html');
                const footerHTML = await footerResponse.text();
                document.getElementById('footer-placeholder').innerHTML = footerHTML;
            } catch (error) {
                console.error('í—¤ë”/í‘¸í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìœ ì§€ë³´ìˆ˜ í•¨ìˆ˜ë“¤
        function cleanupOldLogs() {
            alert('ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.');
        }

        function exportAllData() {
            alert('ì „ì²´ ë°ì´í„° ë°±ì—… ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.');
        }
    </script>
</body>
</html>
